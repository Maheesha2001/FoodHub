@model List<FoodHub.ViewModels.Checkout.CartItemViewModel>

@{
    ViewData["Title"] = "Checkout - Cart Review";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div style="min-height:100vh; padding:40px;">
    <div class="checkout-steps mb-4">
        <ul class="steps d-flex justify-content-between list-unstyled">
            <li class="step active"><span class="step-title">Shopping Cart</span></li>
            <li class="step"><span class="step-number">2</span><span class="step-title">Delivery Information</span></li>
            <li class="step"><span class="step-number">3</span><span class="step-title">Confirmation & Payment</span></li>
        </ul>
    </div>

    <h2 class="mb-4">Checkout: Cart Review</h2>

    <table class="table table-striped">
        <thead>
            <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Quantity</th>
                <th>Unit Price</th>
                <th>Total</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="checkout-cart-body"></tbody>
        <tfoot>
            <tr>
                <td colspan="4" class="text-end"><strong>Total:</strong></td>
                <td id="checkout-cart-total">0.00</td>
                <td></td>
            </tr>
        </tfoot>
    </table>

    <div class="d-flex justify-content-between">
        <a class="btn btn-secondary" href="/Customer/Menu">‚Üê Continue Shopping</a>
       @* <a class="btn btn-primary" href="@Url.Action("DeliveryInfo", "Checkout",  new { area = "Customer" })">
    Next: Delivery Info ‚Üí
</a> *@
@* <a class="btn btn-primary"
   href="@Url.Action("DeliveryInfo", "Checkout", new { area = "Customer", code = TempData["FrozenOrderCode"] })">
    Next: Delivery Info c‚Üí
</a> *@
  @{
    var cartCode = (Model != null && Model.Any()) ? Model.FirstOrDefault()?.Code ?? "" : "";
}


<div class="d-flex justify-content-between">
    <a class="btn btn-secondary" href="/Customer/Menu">‚Üê Continue Shopping</a>

    @if (!string.IsNullOrEmpty(cartCode))
    {
        <a class="btn btn-primary"
           href="@Url.Action("DeliveryInfo", "Checkout", new { area = "Customer", code = cartCode })">
            Next: Delivery Info ‚Üí
        </a>
    }
    else
    {
        <a class="btn btn-primary disabled">Next: Delivery Info ‚Üí</a>
    }
</div>



    </div>
</div>

@section Scripts {
<script>
 const getCartUrl = '@Url.Action("GetCartItems", "Cart", new { area = "" })';
const updateQtyUrl = '@Url.Action("UpdateItemQuantity", "Cart", new { area = "" })';
//const removeItemUrl = '@Url.Action("RemoveItem", "Cart", new { area = "" })';
//const removeItemUrl = '@Url.Action("RemoveItem", "Cart", new { area = "" })';
const removeItemUrl = '@Url.Content("~/Cart/RemoveItem")';

const saveCheckoutUrl = '@Url.Action("SaveCheckoutCart", "Cart", new { area = "" })';
@* const isFrozen = @((TempData["FrozenOrderId"] != null) ? "true" : "false"); *@

let isFrozen = false;

@* async function checkFrozenStatus() {
    try {
        const res = await fetch("/Customer/Checkout/IsCartFrozen");
        const data = await res.json();
        isFrozen = data.frozen;
        console.log("DB Frozen Check ‚Üí", isFrozen);
    } catch (err) {
        console.error("Error checking frozen status:", err);
    }
} *@

async function checkFrozenStatus() {
    try {
        const res = await fetch("/Customer/Checkout/IsCartFrozen", {
            credentials: "same-origin"  // ensures cookies are sent
        });

        if (!res.ok) {
            console.error("HTTP error", res.status);
            return;
        }

        const data = await res.json();
        isFrozen = data.frozen;
        console.log("DB Frozen Check ‚Üí", isFrozen);
    } catch (err) {
        console.error("Error checking frozen status:", err);
    }
}


async function loadCart() {
    try {
        const res = await fetch(getCartUrl);
        const data = await res.json();

        const tbody = document.getElementById("checkout-cart-body");
        const totalCell = document.getElementById("checkout-cart-total");

        if (!data.items || data.items.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Your cart is empty.</td></tr>`;
            totalCell.innerText = "0.00";
            return;
        }

        let html = "";
        let total = 0;

        
        data.items.forEach((item) => {
    const lineTotal = item.price * item.quantity;
    total += lineTotal;

    // Freeze inputs/buttons if isFrozen
let qtyInput = "";
let removeBtn = "";

    if(isFrozen){
        qtyInput = `<input type="number" class="form-control quantity-input" value="${item.quantity}" min="1" style="width:80px;" disabled />` ;
        removeBtn = "";
        console.log("Correct is frozen");
    } else {
       // qtyInput = `<input type="number" class="form-control quantity-input" value="${item.quantity}" min="1" style="width:80px;" />`;
          qtyInput = `
        <div class="d-flex align-items-center qty-control" style="gap:5px;">
            <button type="button" class="btn btn-outline-secondary btn-sm qty-btn" data-action="dec" data-id="${item.id}" data-type="${item.type}">
                <i class="bi bi-dash"></i>
            </button>
            <input type="number" class="form-control text-center quantity-input" 
                value="${item.quantity}" min="1" style="width:70px;" readonly />
            <button type="button" class="btn btn-outline-secondary btn-sm qty-btn" data-action="inc" data-id="${item.id}" data-type="${item.type}">
                <i class="bi bi-plus"></i>
            </button>
        </div>`;
        removeBtn = `<button type="button" class="btn btn-sm btn-danger remove-item">X</button>`;
        console.log("WRONG is frozen");
    }
      
   
    html += `
        <tr data-id="${item.id}" data-type="${item.type}">
            <td>${item.name}</td>
            <td>${item.type}</td>
            <td>${qtyInput}</td>
            <td class="unit-price">${item.price.toFixed(2)}</td>
            <td class="line-total">${lineTotal.toFixed(2)}</td>
            <td>${removeBtn}</td>
        </tr>`;
});


        tbody.innerHTML = html;
        totalCell.innerText = total.toFixed(2);
        attachEvents();
    } catch (err) {
        console.error("Error loading cart:", err);
    }
}



function attachEvents() {
    if (isFrozen) {
        // ‚ùå Freeze UI
        document.querySelectorAll('.quantity-input').forEach(input => input.disabled = true);
        document.querySelectorAll('.remove-item').forEach(btn => btn.remove());
        return;
    }

    // Editable cart: normal events
    document.querySelectorAll('.quantity-input').forEach(input => {
        input.addEventListener('change', async function () {
            const row = input.closest('tr');
            const id = row.dataset.id;
            const type = row.dataset.type;
            const qty = parseInt(input.value);

            const res = await fetch(`${updateQtyUrl}?productId=${id}&quantity=${qty}&type=${encodeURIComponent(type)}`, { method: 'POST' });
            if (!res.ok) return console.error('Failed to update quantity:', res.status);
            const data = await res.json();
            if (data.success) {
                const price = parseFloat(row.querySelector('.unit-price').innerText);
                row.querySelector('.line-total').innerText = (price * qty).toFixed(2);
                updateTotal();
            }
        });
    });

    document.querySelectorAll('.remove-item').forEach(btn => {
        btn.addEventListener('click', async function () {
            const row = btn.closest('tr');
            const id = row.dataset.id;
            const type = row.dataset.type;

            //const res = await fetch(`${removeItemUrl}?productId=${id}&type=${encodeURIComponent(type)}`, { method: 'POST' });
           // const res = await fetch(removeItemUrl + `?productId=${id}&type=${encodeURIComponent(type)}`, { method: 'POST' });
            const res = await fetch(`${removeItemUrl}?productId=${id}&type=${encodeURIComponent(type)}`, { method: 'POST' });
            if (!res.ok) return console.error('Failed to remove item:', res.status);
            const data = await res.json();
            if (data.success) {
                row.remove();
                updateTotal();
            }
        });
    });

    // Handle up/down buttons for quantity
document.querySelectorAll('.qty-btn').forEach(btn => {
    btn.addEventListener('click', async function () {
        const action = btn.dataset.action;
        const id = btn.dataset.id;
        const type = btn.dataset.type;

        const row = btn.closest('tr');
        const input = row.querySelector('.quantity-input');
        let qty = parseInt(input.value);

        if (action === "inc") qty++;
        if (action === "dec" && qty > 1) qty--;

        input.value = qty;

        // Update UI totals
        const price = parseFloat(row.querySelector('.unit-price').innerText);
        row.querySelector('.line-total').innerText = (price * qty).toFixed(2);
        updateTotal();

        // Update server
        try {
            const res = await fetch(`${updateQtyUrl}?productId=${id}&quantity=${qty}&type=${encodeURIComponent(type)}`, { method: 'POST' });
            if (!res.ok) console.error("Failed to update quantity:", res.status);
        } catch (err) {
            console.error("Error updating quantity:", err);
        }
    });
});

}

async function tryRestoreLocalCartIfNeeded() {
    try {
        // ‚úÖ Always load server cart first
        const serverRes = await fetch(getCartUrl);
        let serverJson = { items: [] };
        console.log("üîç Raw server response:", serverJson);

        try {
            serverJson = await serverRes.json();
        } catch (e) {
            console.warn("GetCartItems did not return JSON:", e);
        }

        const serverItems = serverJson?.items || [];
        const localCart = JSON.parse(localStorage.getItem("cart") || "[]");

        // ‚úÖ If DB already has items, ignore local storage and load DB cart
        if (serverItems.length > 0) {
            console.log("‚úÖ Server cart has priority ‚Äî loading DB cart");
            localStorage.removeItem("cart"); // clear old local storage
            await loadCart(); // just show DB data
            return;
        }

        // ‚úÖ If DB is empty but local has items, push them to DB
        if (localCart.length > 0) {
            console.log("üöÄ Pushing local cart to DB:", localCart);

            const payload = localCart.map(i => ({
                id: i.id.toString(),
                name: i.name,
                type: i.type,
                price: i.price,
                quantity: i.quantity
            }));

            const postRes = await fetch(saveCheckoutUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
                credentials: "same-origin"
            });

            if (postRes.ok) {
                console.log("‚úÖ Local cart synced to DB");
                localStorage.removeItem("cart");
                await loadCart();
            } else {
                console.error("‚ùå Failed to sync cart:", await postRes.text());
                await loadCart();
            }
        } else {
            // ‚úÖ Both empty, just load UI
            console.log("üü° Both server and local are empty");
            await loadCart();
        }

    } catch (err) {
        console.error("‚ùå Error during cart restore attempt:", err);
        await loadCart();
    }
}

function updateTotal() {
    let total = 0;
    document.querySelectorAll('.line-total').forEach(cell => {
        total += parseFloat(cell.innerText);
    });
    document.getElementById('checkout-cart-total').innerText = total.toFixed(2);
}


document.addEventListener("DOMContentLoaded", async () => {
    await checkFrozenStatus();
    await tryRestoreLocalCartIfNeeded(); // ‚úÖ That's it. Do NOT restore again manually.
});

</script>
}


<style>
    /* Disable input styling fully when frozen */
    input[disabled] {
        background-color: #f5f5f5;
        color: #555;
        cursor: not-allowed;
        border: none;
        box-shadow: none;
        pointer-events: none;
    }

    /* Remove arrow buttons in number input */
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    input[type=number] {
        -moz-appearance: textfield; /* Firefox */
    }

    /* Remove delete icon column space */
    td:empty {
        display: none;
    }
</style>
