@model IEnumerable<FoodHub.ViewModels.Orders.MyOrderViewModel>
@{
    ViewData["Title"] = "My Orders";
}

<div class="customerOrderhistoryMain">
    <div>
    <h2 class="mb-4 text-center fw-bold">My Orders</h2>

    @if (!Model.Any())
    {
        <div class="alert alert-info text-center">
            You havenâ€™t placed any orders yet.
        </div>
    }
    else
    {
        <div class="table-responsive shadow-sm rounded-3">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>Order Code</th>
                        <th>Date</th>
                        <th>Total Amount</th>
                        <th>Payment Status</th>
                        <th>Order Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var order in Model)
                    {
                        <tr>
                            <td>@order.Code</td>
                            <td>@order.CreatedAt.ToString("yyyy-MM-dd HH:mm")</td>
                            <td>$ @(order.TotalAmount.ToString("N2"))</td>
                            <td>
                                @if (order.PaymentStatus == "Pending")
                                {
                                    <span class="badge bg-warning text-dark">Pending</span>
                                }
                                else if (order.PaymentStatus == "Success")
                                {
                                    <span class="badge bg-success">Paid</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">@order.PaymentStatus</span>
                                }
                            </td>
                            @* <td>
                                @if (order.Status == "Completed")
                                {
                                    <span class="badge bg-success">Completed</span>
                                }
                                else if (order.Status == "Pending")
                                {
                                    <span class="badge bg-warning text-dark">Pending</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">@order.Status</span>
                                }
                            </td>
                            <td>
                               @if (order.DeliveryStatus == "Out for Delivery")
                                {
                                    <span class="badge bg-primary">Out for Delivery</span>
                                }
                                else if (order.DeliveryStatus == "Pending")
                                {
                                    <span class="badge bg-warning text-dark">Pending</span>
                                }
                                else if (order.DeliveryStatus == "Delivered")
                                {
                                    <span class="badge bg-success">Delivered</span>
                                }
                                else if (order.DeliveryStatus == "Cancelled")
                                {
                                    <span class="badge bg-danger">Cancelled</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">@order.DeliveryStatus</span>
                                }

                            </td> *@
                            <td>
                                @{
                                    string displayStatus = order.Status;
                                    string badgeClass = "bg-secondary";

                                    // ðŸ”¹ If order is Pending â†’ show only "Pending" and skip delivery
                                    if (order.Status == "Pending")
                                    {
                                        displayStatus = "Pending";
                                        badgeClass = "bg-warning text-dark";
                                    }
                                    else if (order.DeliveryStatus == "Pending")
                                    {
                                        displayStatus = "Pending";
                                        badgeClass = "bg-warning text-dark";
                                    }
                                    // ðŸ”¹ If delivery is Out for Delivery â†’ override order status
                                    else if (order.DeliveryStatus == "Out for Delivery")
                                    {
                                        displayStatus = "Out for Delivery";
                                        badgeClass = "bg-primary";
                                    }
                                    // ðŸ”¹ If delivery is Delivered â†’ show Delivered
                                    else if (order.DeliveryStatus == "Delivered")
                                    {
                                        displayStatus = "Delivered";
                                        badgeClass = "bg-success";
                                    }
                                    // ðŸ”¹ If delivery is Cancelled â†’ show Cancelled
                                    else if (order.DeliveryStatus == "Cancelled")
                                    {
                                        displayStatus = "Cancelled";
                                        badgeClass = "bg-danger";
                                    }
                                    // ðŸ”¹ Otherwise, keep the orderâ€™s actual status
                                    else if (order.Status == "Completed")
                                    {
                                        displayStatus = "Completed";
                                        badgeClass = "bg-success";
                                    }
                                }

                                <span class="badge @badgeClass">@displayStatus</span>
                            </td>

                            
                            <td>
                                 @if (string.IsNullOrEmpty(order.PaymentStatus) || order.PaymentStatus == "Not Available")
                                    {
                                        <button class="btn btn-sm btn-outline-primary pay-btn" data-orderid="@order.Id">
                                            <i class="bi bi-credit-card"></i> Pay Now
                                        </button>
                                    }
                                else
                                {
                                   <a href="@Url.Action("Details", "MyOrders", new { orderCode = order.Code })" 
                                        class="btn btn-sm btn-outline-secondary">
                                            <i class="bi bi-eye"></i> View
                                        </a>

                                }
                            </td>
                        </tr>

                        <!-- Accordion-style details row -->
                        <tr id="details-@order.Id" class="order-details-row" style="display:none;">
                            <td colspan="6" class="p-0">
                                <div class="details-container bg-light p-3">
                                    <div class="text-center text-muted small">Loading...</div>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    </div>
</div>


@section Styles {
    <style>
        /* Center success content and keep footer visible */
        .customerOrderhistoryMain {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            min-height: calc(100vh - 112px); /* Footer space (auto-adjusts if footer grows) */
            padding-bottom: 35px;
        }
    </style>
}

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            // Handle Pay Now button click
            document.querySelectorAll(".pay-btn").forEach(btn => {
                btn.addEventListener("click", function () {
                    const orderId = this.getAttribute("data-orderid");
                    if (confirm("Proceed to payment for Order #" + orderId + "?")) {
                        window.location.href = '@Url.Action("Payment", "Checkout", new { area = "Customer" })' + `?orderId=${orderId}`;
                    }
                });
            });

            // Handle View / Collapse button click
            document.querySelectorAll(".view-btn").forEach(btn => {
                btn.addEventListener("click", function () {
                    const orderId = this.getAttribute("data-orderid");
                    const detailsRow = document.getElementById(`details-${orderId}`);
                    const container = detailsRow.querySelector(".details-container");

                    // If currently hidden â†’ expand and load content
                    if (detailsRow.style.display === "none") {
                        detailsRow.style.display = "table-row";
                        container.innerHTML = `<div class="text-center text-muted small">Loading details...</div>`;

                        fetch(`/MyOrders/GetOrderDetails?id=${orderId}`)
                            .then(res => {
                                if (!res.ok) throw new Error("Failed to load details");
                                return res.text();
                            })
                            .then(html => {
                                container.innerHTML = html;
                            })
                            .catch(err => {
                                container.innerHTML = `<div class="text-danger text-center small">${err.message}</div>`;
                            });
                    } 
                    // If open â†’ collapse
                    else {
                        detailsRow.style.display = "none";
                        container.innerHTML = "";
                    }
                });
            });
        });
    </script>
}
