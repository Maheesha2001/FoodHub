@model IEnumerable<FoodHub.ViewModels.Orders.MyOrderViewModel>
@{
    ViewData["Title"] = "My Orders";
}

<div class="container mt-5">
    <h2 class="mb-4 text-center fw-bold">My Orders</h2>

    @if (!Model.Any())
    {
        <div class="alert alert-info text-center">
            You haven’t placed any orders yet.
        </div>
    }
    else
    {
        <div class="table-responsive shadow-sm rounded-3">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>Order ID</th>
                        <th>Date</th>
                        <th>Total Amount</th>
                        <th>Payment Status</th>
                        <th>Order Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var order in Model)
                    {
                        <tr>
                            <td>@order.Id</td>
                            <td>@order.CreatedAt.ToString("yyyy-MM-dd HH:mm")</td>
                            <td>$ @(order.TotalAmount.ToString("N2"))</td>
                            <td>
                                @if (order.PaymentStatus == "Pending")
                                {
                                    <span class="badge bg-warning text-dark">Pending</span>
                                }
                                else if (order.PaymentStatus == "Success")
                                {
                                    <span class="badge bg-success">Paid</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">@order.PaymentStatus</span>
                                }
                            </td>
                            <td>
                                @if (order.Status == "Completed")
                                {
                                    <span class="badge bg-success">Completed</span>
                                }
                                else if (order.Status == "Pending")
                                {
                                    <span class="badge bg-warning text-dark">Pending</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">@order.Status</span>
                                }
                            </td>
                            <td>
                                @if (order.Status == "Pending" && order.PaymentStatus == "Pending")
                                {
                                    <button class="btn btn-sm btn-outline-primary pay-btn" data-orderid="@order.Id">
                                        <i class="bi bi-credit-card"></i> Pay Now
                                    </button>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-outline-secondary view-btn" data-orderid="@order.Id">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                }
                            </td>
                        </tr>

                        <!-- Accordion-style details row -->
                        <tr id="details-@order.Id" class="order-details-row" style="display:none;">
                            <td colspan="6" class="p-0">
                                <div class="details-container bg-light p-3">
                                    <div class="text-center text-muted small">Loading...</div>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            // Handle Pay Now button click
            document.querySelectorAll(".pay-btn").forEach(btn => {
                btn.addEventListener("click", function () {
                    const orderId = this.getAttribute("data-orderid");
                    if (confirm("Proceed to payment for Order #" + orderId + "?")) {
                        window.location.href = '@Url.Action("Payment", "Checkout", new { area = "Customer" })' + `?orderId=${orderId}`;
                    }
                });
            });

            // Handle View / Collapse button click
            document.querySelectorAll(".view-btn").forEach(btn => {
                btn.addEventListener("click", function () {
                    const orderId = this.getAttribute("data-orderid");
                    const detailsRow = document.getElementById(`details-${orderId}`);
                    const container = detailsRow.querySelector(".details-container");

                    // If currently hidden → expand and load content
                    if (detailsRow.style.display === "none") {
                        detailsRow.style.display = "table-row";
                        container.innerHTML = `<div class="text-center text-muted small">Loading details...</div>`;

                        fetch(`/MyOrders/GetOrderDetails?id=${orderId}`)
                            .then(res => {
                                if (!res.ok) throw new Error("Failed to load details");
                                return res.text();
                            })
                            .then(html => {
                                container.innerHTML = html;
                            })
                            .catch(err => {
                                container.innerHTML = `<div class="text-danger text-center small">${err.message}</div>`;
                            });
                    } 
                    // If open → collapse
                    else {
                        detailsRow.style.display = "none";
                        container.innerHTML = "";
                    }
                });
            });
        });
    </script>
}
